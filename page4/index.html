

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <title>Des articles sur Magento et plein d'autres choses ! - Jacques Bodin-Hullin, développeur Magento</title>
    
    
    <meta name="author" content="Jacques Bodin-Hullin">
    <link href="/css/style.css" rel="stylesheet" type="text/css" />
    <link href="/css/pygments.css" rel="stylesheet" type="text/css" media="all">
    <link href="/js/fancybox/jquery.fancybox.css" rel="stylesheet" type="text/css" media="all">
    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="/favicon.ico">
  <!-- Update these with your own images
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
    <link rel="alternate" type="application/rss+xml" title="Jacques Bodin-Hullin - Latest Posts" href="/atom.xml" >

    <script type="text/javascript" src="/js/jquery-1.10.2.min.js" ></script>
    <script type="text/javascript" src="/js/bootstrap.min.js" ></script>
    <script type="text/javascript" src="/js/fancybox/jquery.fancybox.pack.js" ></script>
    <script type="text/javascript" src="/js/event.js" ></script>
    <script type="text/javascript" src="/js/functions.js" ></script>

    <style for="gists"></style>
</head>
<body class="">

<div id="mainWrap">

    <div id="topWrap">
        <div id="headerWrap">
            <p>
                Jacques Bodin-Hullin
                <span class="baseline">Développeur d'applications Web</span>
            </p>
            <a href="http://jacques.sh"></a>

            <div id="magento_certified">
                <a href="http://www.magentocommerce.com/certification/directory/dev/69536/" title="L'Agence Monsieur Biz est certifiée Magento Solution Specialist" class="solution-specialist" target="_blank"></a>
                <a href="http://www.magentocommerce.com/certification/directory/dev/69536/" title="L'Agence Monsieur Biz est certifiée Magento Developer Plus" class="developer-plus" target="_blank"></a>
                <a href="http://www.magentocommerce.com/certification/directory/dev/69536/" title="Jacques Bodin-Hullin, développeur certifié Magento Developer" class="developer" target="_blank"></a>
                <a href="http://www.magentocommerce.com/certification/directory/dev/69536/" title="Jacques Bodin-Hullin est développeur certifié Magento Front End Developer" class="frontend-developer" target="_blank"></a>
            </div>



        </div>

        <blockquote id="quoteWrap">
            
            <p>
                La perfection est atteinte non quand il ne reste rien à ajouter, mais quand il ne reste
                rien à enlever.
            </p>
            <div><cite>Antoine de Saint Exupéry</cite></div>
            
        </blockquote>

        <div class="menu-wrapper">
            <ul id="menu">
                
                <li><a href="/"><span></span>Accueil</a></li>
                
                <li><a href="https://github.com/jacquesbh" target="_blank"><span></span>Code</a></li>
                
                
    
        
    

    
        
            
            <li><a href="/a-propos.html"><span></span>A propos</a></li>
            
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
            
            <li><a href="/references.html"><span></span>Références</a></li>
            
        
    

    
        
    

    
        
    

    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    




                <li class="search">
                    <form action="/search.html" method="get" id="search_form">
                        <div>
                            <input type="text" name="q" placeholder="Votre recherche" />
                        </div>
                    </form>
                </li>
            </ul>
        </div>

        <div class="mbiz">
            <p>
                <a href="http://monsieurbiz.com" title="Découvrez l'agence Monsieur Biz, spécialiste Magento">
                    <img src="/img/monsieurbiz_bg.png" title="L'Agence Monsieur Biz" />
                    <span>Vous cherchez une agence spécialiste du e-commerce certifiée Magento Solution Specialist ? L'agence Monsieur Biz est faite pour vous !</span>
                </a>
            </p>
        </div>
    </div>

    <div id="globalWrap">



<div id="sideWrap">

<h2>A propos</h2>
<div>
    <img src="/img/visage_edito.png" alt="" width="277" height="88" />
    <p>Bienvenue sur mon blog !</p>
    <p>Je suis <a href="/a-propos.html">Jacques Bodin-Hullin, développeur PHP confirmé, certifié Magento</a>.</p>
    <p>Ce blog est dédié au développement, PHP essentiellement, Javascript un peu, et tout le reste, évidemment !</p>
    <p>N'hésitez pas à aller faire un tour <a href="https://github.com/jacquesbh">sur mon github</a> afin de suivre mes projets et à poster vos remarques sur les articles que vous trouvez ici, c'est toujours constructif !</p>
    <p>J'espère que vous trouverez ici l'information que vous cherchez.</p>
</div>

<div>
    <p>Je suis également le fondateur de <a href="http://monsieurbiz.com">Monsieur Biz, une agence spécialisée Magento</a>.</p>
</div>

<hr />




<h2>Tags</h2>

<p class="tags">

    <span style="font-size:14.4px"><a href="/search.html#!tag=Jekyll">Jekyll</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=Markdown">Markdown</a></span>

    <span style="font-size:14.4px"><a href="/search.html#!tag=GitHub">GitHub</a></span>

    <span style="font-size:39.599999999999994px"><a href="/search.html#!tag=Magento">Magento</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=Snippets">Snippets</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=Vim">Vim</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=Netbeans">Netbeans</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=jQuery">jQuery</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=Javascript">Javascript</a></span>

    <span style="font-size:14.4px"><a href="/search.html#!tag=PHP">PHP</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=URL">URL</a></span>

    <span style="font-size:14.4px"><a href="/search.html#!tag=Bonnes pratiques">Bonnes pratiques</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=Ajax">Ajax</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=Homepage">Homepage</a></span>

    <span style="font-size:16.8px"><a href="/search.html#!tag=Layout">Layout</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=CMS">CMS</a></span>

    <span style="font-size:15.6px"><a href="/search.html#!tag=The Installer">The Installer</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=Android">Android</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=Proxy">Proxy</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=HTTP">HTTP</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=Git">Git</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=Workflow">Workflow</a></span>

    <span style="font-size:14.4px"><a href="/search.html#!tag=Cache">Cache</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=Block">Block</a></span>

    <span style="font-size:14.4px"><a href="/search.html#!tag=Module">Module</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=Cart">Cart</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=Customer">Customer</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=Handle">Handle</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=Events">Events</a></span>

    <span style="font-size:15.6px"><a href="/search.html#!tag=Attributes">Attributes</a></span>

    <span style="font-size:15.6px"><a href="/search.html#!tag=Product">Product</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=Product type">Product type</a></span>

    <span style="font-size:14.4px"><a href="/search.html#!tag=EAV">EAV</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=Thème">Thème</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=MariaDB">MariaDB</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=MySQL">MySQL</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=Images">Images</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=Aides de vue">Aides de vue</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=OS X">OS X</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=Astuces">Astuces</a></span>

    <span style="font-size:14.4px"><a href="/search.html#!tag=MageConf">MageConf</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=Émulation">Émulation</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=Meet Magento">Meet Magento</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=Productivité">Productivité</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=SSL">SSL</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=Sécurité">Sécurité</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=COMODO">COMODO</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=gandi">gandi</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=Fabric">Fabric</a></span>

    <span style="font-size:13.2px"><a href="/search.html#!tag=Vagrant">Vagrant</a></span>

</p>

<hr />



</div>


<div id="contentWrap">

    


    <hr />
    <h2><a href="/ajouter-un-handle-personnalise-sur-une-page-sur-magento.html">Ajouter un handle au layout sur Magento</a></h2>
    <div class="content post">
        <blockquote><p>Hey Jacques, c'est possible d'avoir un affichage différent suivant le type de produit ?</p></blockquote>

<p>Bah évidemment ! Et c'est même natif sur Magento !</p>

<blockquote><p>Et on peut faire la même chose sur notre système éditorial ? Pour que suivant le type de news l'affichage soit différent ?</p></blockquote>

<p>Oui on peut, mais là ça implique un peu de dev !</p>

<blockquote><p>Il te faut combien de temps ?</p></blockquote>

<p>Je ne sais pas, pour mettre en place la personnalisation il faut 30 petites minutes... Ensuite pour faire ton templating bah ça dépendra de l'intégration que tu vas me fournir !</p>

<hr />

<p>C'est typiquement le genre de discussion qu'on peut avoir avec un chef de projet qui a besoin d'aller vite et qui vient vous voir pour estimer le travail qu'il va devoir donner aux développeurs. Mais quand on donne au développeur, qui, soit dit en passant, n'a jamais touché aux <em>handles personnalisés</em> sur Magento, ce travail... Et bien il a du mal à voir comment faire, et surtout... comment le faire en 30 minutes !</p>

<p>Laissez-moi vous montrer ;)</p>

<!-- 


<hr />

<p>Avant toute chose vous devez savoir <a href="http://jacques.sh/le-layout-sur-magento.html">comment fonctionne le layout sur Magento</a>. Sans ça vous risquez d'être un peu perdu dans la suite de cet article.</p>

<p>On sait que les handles par défaut qui sont chargés sur notre page <code>frontname/controller/action</code> sont les suivants :</p>

<ul>
<li><code>default</code> : handle principal par défaut</li>
<li><code>STORE_default</code> : handle du store (par défaut)</li>
<li><code>THEME_frontend_default_default</code> : handle du thème (par défaut)</li>
<li><code>frontname_controller_action</code> : handle de notre action</li>
</ul>


<p>On peut aussi avoir les handles <code>customer_logged_out</code> ou <code>customer_logged_in</code> qui permettent de changer l'affichage suivant si le visiteur est connecté ou non.</p>

<p>Maintenant qu'on a ces handles il faut songer à en ajouter... Mais comment ?</p>

<h2>La méthode <code>loadLayout()</code></h2>

<p>Quand on a l'occasion de créer nos propres actions il est vite nécessaire de charger le layout (et donc les handles cités plus haut). Et pour ça c'est la méthode <code>loadLayout()</code> dans notre contrôleur qui fait l'affaire.</p>

<p>Mais cette méthode, elle fait quoi exactement ??</p>

<p>La méthode <code>loadLayout()</code> décortiquée/complétée/nettoyée et commentée ci-dessous :</p>

<script type="text/javascript">gist(jacquesbh/4401568, 'load_layout.php', '18-19,30-31,33-35,37-39,50-53');</script>


<p>Vous avez compris le fonctionnement ? Les points les plus importants sont surlignés.</p>

<p>Ok, next ;)</p>

<h2>Un évènement</h2>

<p>Vous avez sans doute remarqué qu'un évènement <code>controller_action_layout_load_before</code> est lancé pile poil avant la génération du XML du Layout qui sera utilisé sur la page... C'est pas par hasard hein ;)</p>

<p>Sauf que le nom de cet évènement, quand on y regarde de plus près, bah il est commun à toutes les pages ! Comment savoir alors si on est bien sur <code>frontname/controller/action</code> ?</p>

<p>Je vais vous donner une solution rapide à mettre en place mais qui ne fonctionnera que sur certains projets assez petits car si vous voulez souvent "taper" sur cet évènement il faudra trouver autre chose. Par chance je l'explique plus bas !</p>

<p>Nous devons dans tous les cas agir sur notre évènement, donc un peu de config, et une classe avec une méthode <code>layoutLoadBefore</code> (pas très original, mais assez parlant) et le tour est joué !</p>

<p>Dans cette méthode on va simplement vérifier que nous sommes bien en train d'afficher notre action et nous allons pouvoir y faire l'ajout de notre nouvel handle :</p>

<script type="text/javascript">gist(jacquesbh/4401568, 'observer_handle.php', '12-18');</script>


<p>L'idée c'est surtout de ne pas utiliser une triple condition à la <code>if ($action == 'action' &amp;&amp; $controller == 'controller' &amp;&amp; $module == 'module')</code> car c'est bien trop lourd. On a la possibilité d'avoir un nom d'action précis, alors on fait un case !</p>

<p>Ensuite on ajoute notre handle personnalisé, en majuscules (eh oui !).</p>

<p>Rien ne nous empêche de récupérer un objet dans le registre pour y ajouter un peu de dynamisme (c'est l'idée en fait) : <em>exemple avec une "news"</em></p>

<script type="text/javascript">gist(jacquesbh/4401568, 'observer_news.php', '15-18');</script>


<p>A vous de jouer !</p>

<h2>Vérifions</h2>

<p>Pour vérifier que notre handle est présent, rien de plus simple : on ouvre le fichier <code>index.php</code> et on ajoute à la fin du fichier ces quelques lignes.</p>

<script type="text/javascript">gist(jacquesbh/4401568, 'index.php');</script>


<p>On actualise ! Et pof ! (tout en bas..)</p>

<h2>En mieux ?</h2>

<p>Si vous devez faire un event sur plein de modules car vous avez souvent besoin de faire de l'affichage personnalisé (c'est super pratique il faut l'avouer !) et bien je vous propose de faire plutôt ceci : lancer un évènement un peu plus personnalisé !</p>

<p>Vous vous souvenez, on a un évènement "global". Mais cet évènement nous donne le nom de l'action (via <code>$observer-&gt;getAction()-&gt;getFullActionName()</code>).</p>

<p>On peut donc lancer un évènement précis pour chaque page sur notre e-commerce :</p>

<script type="text/javascript">gist(jacquesbh/4401568, 'observer_dispatch.php', '13-16');</script>


<p>De cette manière on peut utiliser l'évènement <code>controller_action_layout_load_before_frontname_controller_action</code> pour ajouter notre handle sans crainte !</p>

<h2>Et au final ?</h2>

<p>Au final... n'abusez pas des évènements ;)</p>

 -->





    </div>
    <div class="voirPlus">
        <div class="social">
            <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://jacques.sh/ajouter-un-handle-personnalise-sur-une-page-sur-magento.html" data-text="Ajouter un handle au layout sur Magento" data-via="jacquesbh">Tweet</a>
        </div>
        
        <a href="/ajouter-un-handle-personnalise-sur-une-page-sur-magento.html#disqus_thread">Commentaires</a> -
        

        <a href="/ajouter-un-handle-personnalise-sur-une-page-sur-magento.html">Lire l'article</a>

    </div>

    <hr />
    <h2><a href="/ajouter-un-script-externe-au-header-sur-magento.html">Ajouter un script externe au header sur Magento</a></h2>
    <div class="content post">
        <p>On a toujours besoin d'ajouter un bout de script ou un script externe complet dans le header de nos pages mais on ne sait jamais comment s'y prendre ! Doit-on préférer la solution simple qui consiste à modifier le template <code>head.phtml</code> ? Devons-nous ajouter ce bout de code en dur ? Le rendre dynamique ?</p>

<p>Quoiqu'il en soit il y a plusieurs façons de faire et cet article a pour but de vous expliquer celle qui est la plus élégante.</p>

<p>L'idée de cet article est dûe au <a href="http://jacques.sh/le-layout-sur-magento.html#comment-743437791">commentaire de Frédéric Martinez</a> sur mon <a href="http://jacques.sh/le-layout-sur-magento.html">article sur le Layout</a>.</p>

<p>Ouvrez-donc votre éditeur de texte préféré et allons faire un tour dans le Layout...</p>

<!-- 


<hr />

<h2>Le block <code>core/text</code></h2>

<p>Vous connaissez tous le block <code>core/text</code> n'est-ce pas ? Ce petit block bien sympathique sur Magento auquel il suffit de donner un texte pour qu'il puisse s'afficher !</p>

<p>Par exemple si on devait initialiser un tel block voici ce qu'on ferait :</p>

<script src="https://gist.github.com/jacquesbh/4365871.js?file=create_block.php"></script>


<p>Vous voyez peut-être déjà où je veux en venir ?</p>

<p>Et si maintenant notre texte était <code>&lt;script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"&gt;&lt;/script&gt;</code> ?</p>

<script src="https://gist.github.com/jacquesbh/4365871.js?file=jquery.php"></script>


<p>Ok mais dans le layout ça donne quoi ?</p>

<script src="https://gist.github.com/jacquesbh/4365871.js?file=core_text.xml"></script>


<p><em>Note : N'oubliez pas le <code>&lt;![CDATA[ ]]&gt;</code> !</em></p>

<h2>Direction le <code>&lt;head/&gt;</code> !</h2>

<p>Quand on regarde un peu les templates de base sur Magento on remarque que le <code>page/html/head.phtml</code> contient une ligne fort pratique :</p>

<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getChildHtml</span><span class="p">()</span> <span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>


<p>Cette ligne affiche tous les enfants du block <code>head</code>.</p>

<p>Donc si on ajoute un block comme celui que nous avons créé à priori son contenu sera affiché à la place de cette ligne.</p>

<p>Pour ajouter notre block voici les options possibles :</p>

<ul>
<li>dans le fichier <code>local.xml</code> : ce fichier est chargé après tous les fichiers XML du Layout.</li>
<li>dans le fichier <code>module.xml</code> d'un module existant ou créé pour l'occasion.</li>
</ul>


<p>Afin de nous éviter la création d'un module rien que pour un fichier de layout nous passerons par le <code>local.xml</code>.</p>

<p>Afin d'ajouter un block à notre <code>head</code> nous devons en faire une référence au préalable.</p>

<p>Voici à quoi ressemble notre <code>local.xml</code> :</p>

<script src="https://gist.github.com/jacquesbh/4365871.js?file=local.xml"></script>


<p>A partir de maintenant notre jQuery en provenance de Google est directement chargé dans notre <code>head</code>.</p>

<p>Bien sûr vous pouvez mettre le script d'initialisation d'une librairie par exemple à la place de jQuery.</p>

<h2>Astuce pour vos javascripts</h2>

<p>Lorsqu'on développe sur Magento on est souvent amené à créer des scripts bien à nous.</p>

<p>Et dans ces scripts on a besoin de l'URL du projet dans certains cas.</p>

<p>Voici comment ajouter la "constante" <code>BASE_URL</code> dans le <code>head</code> de vos projets, dans votre local.xml :</p>

<script src="https://gist.github.com/jacquesbh/4365871.js?file=local_base_url.xml"></script>




 -->





    </div>
    <div class="voirPlus">
        <div class="social">
            <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://jacques.sh/ajouter-un-script-externe-au-header-sur-magento.html" data-text="Ajouter un script externe au header sur Magento" data-via="jacquesbh">Tweet</a>
        </div>
        
        <a href="/ajouter-un-script-externe-au-header-sur-magento.html#disqus_thread">Commentaires</a> -
        

        <a href="/ajouter-un-script-externe-au-header-sur-magento.html">Lire la suite du tutoriel</a>

    </div>

    <hr />
    <h2><a href="/supprimer-le-merge-des-paniers.html">Supprimer le merge des paniers</a></h2>
    <div class="content post">
        <p>Sur presque tous les projets Magento sur lesquels j'ai eu l'occasion de travailler il est apparu nécessaire de désactiver le merge du panier du client avec celui du visiteur lors de la connexion.</p>

<p>Pour cela nous devons commencer par <strong>identifier l'évènement</strong> lancé par Magento qui puisse nous permettre de supprimer ce fameux « merge » car aucune option en admin nous permet de l'empêcher.</p>

<!-- 


<hr />

<h2>Identifier l'évènement</h2>

<p>Il suffit d'investiguer un peu :</p>

<p>Objet <code>Mage_Sales_Model_Quote</code>, qui est donc notre objet « panier » :</p>

<p>Ligne 1678 : <code>public function merge(Mage_Sales_Model_Quote $quote)</code>.</p>

<p>Pour vérifier que notre merge passe bien par là on y place un log : <code>Mage::log(__METHOD__ . ':' . __LINE__);</code>.</p>

<p>On se connecte, on ajoute un produit à notre panier, on se déconnecte, on ajoute un produit dans notre panier et on se connecte à nouveau : là on a un log qui apparaît.</p>

<p>Nous avons trouvé sans trop de difficultés l'endroit où est fait le merge.</p>

<p>On remarque dans la méthode le lancement d'un évènement intéressant :</p>

<div class="highlight"><pre><code class="php"><span class="x">Mage::dispatchEvent(</span>
<span class="x">    $this-&gt;_eventPrefix . &#39;_merge_before&#39;,</span>
<span class="x">    array(</span>
<span class="x">    $this-&gt;_eventObject=&gt;$this,</span>
<span class="x">        &#39;source&#39;=&gt;$quote</span>
<span class="x">    )</span>
<span class="x">);</span>
</code></pre></div>


<p>A partir de là on déduit que l'évènement est <code>sales_quote_merge_before</code> et que ces deux données sont :</p>

<ol>
<li>  Le panier <code>quote</code> : panier du client</li>
<li>  Le panier <code>source</code> : panier du visiteur</li>
</ol>


<h2>La construction du module</h2>

<ol>
<li>  Un modèle <code>Observer</code> qui <code>catch</code> notre évènement et qui vide le panier du client.</li>
<li>  Un helper <code>Data</code> qui nous permet de savoir si notre module est activé et si on peut vider le panier du client quand celui du visiteur est vide.</li>
<li>  Un fichier <code>system.xml</code> qui nous permet d'ajouter un peu de configuation (configuration utilisée dans le helper).</li>
</ol>


<h3>Le helper</h3>

<p>Le helper n'est utilisé que pour savoir deux choses :</p>

<ol>
<li>  Notre module est-il activé ? Ou plutôt, pouvons-nous supprimer le merge des paniers ? Via la méthode <code>isActive</code>.</li>
<li>  Pouvons-nous vider le panier du client si le panier du visiteur est vide ? Via la méthode <code>cleanIfEmpty</code>.</li>
</ol>


<script src="http://gist-it.appspot.com/github/jacquesbh/jbh_cartmerge/raw/master/app/code/community/Jbh/CartMerge/Helper/Data.php"></script>


<h3>Le modèle</h3>

<p>Le modèle <code>catch</code> notre évènement est vide le panier du client que si les conditions suivantes sont validées&nbsp;:</p>

<ol>
<li>  Notre module est actif.</li>
<li>  Le panier du visiteur a des produits OU on peut vider le panier du client si le panier du visiteur est vide.</li>
</ol>


<script src="http://gist-it.appspot.com/github/jacquesbh/jbh_cartmerge/raw/master/app/code/community/Jbh/CartMerge/Model/Observer.php"></script>


<h3>Le <code>system.xml</code></h3>

<p>Le <code>system.xml</code> permet d'ajouter un peu de configuration, tout simplement.</p>

<p>Nous ne nous prenons pas la tête avec les <code>ACL</code> car ils sont déjà gérés par Magento pour cette partie de la configuration.</p>

<script src="http://gist-it.appspot.com/github/jacquesbh/jbh_cartmerge/raw/master/app/code/community/Jbh/CartMerge/etc/system.xml"></script>


<h2>Conclusion</h2>

<p>Il est en réalité assez simple, à présent, via le module complet, ou en suivant les étapes de cet article, de supprimer le merge des paniers du visiteur et du client lors de la connexion de notre client.</p>

<p>Vous trouverez le <a href="https://github.com/jacquesbh/jbh_cartmerge">code complet du module sur github</a>.</p>

 -->



    </div>
    <div class="voirPlus">
        <div class="social">
            <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://jacques.sh/supprimer-le-merge-des-paniers.html" data-text="Supprimer le merge des paniers" data-via="jacquesbh">Tweet</a>
        </div>
        
        <a href="/supprimer-le-merge-des-paniers.html#disqus_thread">Commentaires</a> -
        

        <a href="/supprimer-le-merge-des-paniers.html">Lire la suite du tutoriel</a>

    </div>

    <hr />
    <h2><a href="/un-push-pour-vos-produits-sur-magento.html">Un push pour vos produits</a></h2>
    <div class="content post">
        <p>Ne vous êtes-vous jamais retrouvé à créer un block dédié au fameux « push produit » sur votre projet ?</p>

<p>Vous savez, le block qui affiche le produit et qu'on a envie de mettre partout, sur la homepage, sur une mise en avant ou que sais-je !</p>

<p>Cet article va vous montrer la meilleure manière de gérer ce problème en prenant en compte, je l'espère, une bonne partie des contraintes.</p>

<!-- 


<hr />

<div style="text-align: center;">
    <img alt="Push produit Magento EE" src="/images/posts/block-push-produit/push_produit_ee.png" height="272" width="161" style="border: 1px dashed gray;" />
</div>


<p>Pour bien faire nous allons créer le module <code>Jbh_Catalog</code>.</p>

<h2>De quoi avons-nous besoin ?</h2>

<p>Pour commencer, comme je l'explique souvent, nous devons déterminer vers quoi nous allons, et ce que nous allons faire. Il s'agit d'une partie d'analyse importante avant de développer.</p>

<p>On liste.</p>

<p>Nous devons :</p>

<ul>
<li> Créer un block <code>Jbh_Catalog_Block_Product_Push</code> pour afficher notre produit. Nous devons prévoir que notre block puisse s'ajuster au type de produit via des templates spécifiques. On poussera un peu la chose et pour cela nous aurons besoin d'un peu de config. Nous ne gérerons pas le cache de notre block (par défaut sur Magento).</li>
<li> Créer un helper <code>Jbh_Catalog_Helper_Product</code> pour récupérer notre block. Via la méthode <code>getPush($product)</code>.</li>
<li> Créer un modèle <code>Jbh_Catalog_Model_Product_Push_Config</code> pour gérer notre configuration.</li>
</ul>


<p>Maintenant que nous savons ce que nous devons faire, faisons-le par étape.</p>

<h2>La configuration</h2>

<p>Pourquoi avons-nous besoin d'un peu de config ?</p>

<p>Comme tout projet e-commerce j'imagine que votre boutique comprend plusieurs types de produits.</p>

<p>Par défaut Magento en comprend 6 types de produits différents (+ le type <code>Gift Card</code> en EE).</p>

<p>L'idée c'est que bien souvent chaque type de produit a un push un peu différent. Bien souvent on affiche des infos pour un type, par pour l'autre.</p>

<p>Une première solution pour gérer ça est de conditionner simplement notre <code>phtml</code> avec de simples <code>if ($_product-&gt;getTypeId() == Mage_Catalog_Model_Product_Type_Configurable::TYPE_CODE)</code> par exemple.</p>

<p>La seconde consiste à gérer un template par type, avec un template par défaut. Si le template pour le type du produit est défini alors on l'utilise, sinon on prend celui par défaut.</p>

<p>Voici un exemple de configuration que nous pouvons mettre en place :</p>

<div class="highlight"><pre><code class="xml"><span class="nt">&lt;jbh&gt;</span>
    <span class="nt">&lt;catalog&gt;</span>
        <span class="nt">&lt;product&gt;</span>
            <span class="nt">&lt;push&gt;</span>
                <span class="nt">&lt;modes&gt;</span>
                    <span class="nt">&lt;default&gt;</span>
                        <span class="nt">&lt;templates&gt;</span>
                            <span class="nt">&lt;default&gt;</span>jbh/catalog/product/push/grid/default.phtml<span class="nt">&lt;/default&gt;</span>
                            <span class="nt">&lt;simple&gt;</span>jbh/catalog/product/push/grid/default.phtml<span class="nt">&lt;/simple&gt;</span>
                            <span class="nt">&lt;giftcard&gt;</span>jbh/catalog/product/push/grid/default.phtml<span class="nt">&lt;/giftcard&gt;</span>
                        <span class="nt">&lt;/templates&gt;</span>
                    <span class="nt">&lt;/default&gt;</span>
                    <span class="nt">&lt;list&gt;</span>
                        <span class="nt">&lt;templates&gt;</span>
                            <span class="nt">&lt;default&gt;</span>jbh/catalog/product/push/list/default.phtml<span class="nt">&lt;/default&gt;</span>
                            <span class="nt">&lt;simple&gt;</span>jbh/catalog/product/push/list/default.phtml<span class="nt">&lt;/simple&gt;</span>
                            <span class="nt">&lt;giftcard&gt;</span>jbh/catalog/product/push/list/default.phtml<span class="nt">&lt;/giftcard&gt;</span>
                        <span class="nt">&lt;/templates&gt;</span>
                    <span class="nt">&lt;/list&gt;</span>
                <span class="nt">&lt;/modes&gt;</span>
            <span class="nt">&lt;/push&gt;</span>
        <span class="nt">&lt;/product&gt;</span>
    <span class="nt">&lt;/catalog&gt;</span>
<span class="nt">&lt;/jbh&gt;</span>
</code></pre></div>


<p>De cette manière il devient très facile de changer le template pour chaque mode ou chaque type de produit. Et pourquoi pas ajouter un <em>mode</em> ou encore un <em>type</em> fictif ? Après tout rien ne nous empêche d'inventer un mode, par exemple <code>homepage_mea</code>, pour changer les templates de tous les produits qui sont sur la mise en avant sur notre page d'accueil...</p>

<h3>Notre modèle</h3>

<p>Notre modèle <code>Jbh_Catalog_Model_Product_Push_Config</code> comprend les méthodes suivantes :</p>

<ul>
<li> <code>getModes()</code> qui retourne le tableau de tous les modes possibles.</li>
<li> <code>getTemplates($mode)</code> qui retourne un tableau des templates par types, suivant le mode.</li>
</ul>


<p>Bien sûr les <code>path</code> de la configuration sont dans des constantes.</p>

<script src="http://gist-it.appspot.com/github/jacquesbh/jbh_catalog/raw/master/app/code/community/Jbh/Catalog/Model/Product/Push/Config.php"></script>


<h2>Le block</h2>

<p>Notre block dépend surtout du produit et du mode que nous voulons utiliser pour l'affichage.</p>

<p>Pour cela nous indiquons dans notre fichier PHP que notre classe comprend les méthodes implicites suivantes :</p>

<ul>
<li> <code>@method Jbh_Catalog_Block_Product_Push setProduct(Mage_Catalog_Model_Product $product)</code></li>
<li> <code>@method Mage_Catalog_Model_Product getProduct()</code></li>
<li> <code>@method Jbh_Catalog_Block_Product_Push setMode(string $mode)</code></li>
<li> <code>@method string getMode()</code></li>
</ul>


<p>Ces méthodes sont utilisées lors de l'affichage dans la méthode <code>_toHtml</code>.</p>

<p>Si un template a déjà été défini (si jamais il a été forcé par exemple) alors nous ne le changeons pas.</p>

<script src="http://gist-it.appspot.com/github/jacquesbh/jbh_catalog/raw/master/app/code/community/Jbh/Catalog/Block/Product/Push.php"></script>


<h2>Le helper</h2>

<p>Notre helper est la clé de ce module car c'est lui qui va nous retourner notre block pour le produit que nous lui donnons.</p>

<p>Nous développons donc deux méthodes :</p>

<ul>
<li> <code>getPush($product, $mode = null)</code> qui retournera le block instancié.</li>
<li> <code>getPushHtml($product, $mode = null)</code> qui retournera le HTML du block.</li>
</ul>


<p>La première méthode fera juste une petite vérification : Notre variable <code>$product</code> est-elle bien un objet du type <code>Mage_Catalog_Model_Product</code> ? Si ça n'est pas le cas alors on considère que c'est un identifiant entier, et on <code>load</code> le produit. Ensuite on retourne notre nouveau block avec le produit et le mode dans ses données (via le <code>Varien_Object</code> hérité).</p>

<script src="http://gist-it.appspot.com/github/jacquesbh/jbh_catalog/raw/master/app/code/community/Jbh/Catalog/Helper/Product.php"></script>


<h2>Comment ça marche ?</h2>

<p>Pour utiliser notre block rien de plus simple !</p>

<p>Appelons simplement la méthode <code>getPushHtml</code> de notre helper :</p>

<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="k">echo</span> <span class="nx">Mage</span><span class="o">::</span><span class="na">helper</span><span class="p">(</span><span class="s1">&#39;jbh_catalog/product&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getPushHtml</span><span class="p">(</span><span class="nv">$product</span><span class="p">,</span> <span class="nv">$mode</span><span class="p">);</span>
</code></pre></div>


<p>Le <code>$mode</code> n'est pas obligatoire.</p>

<p>Le <code>$product</code> peut être un produit instancié ou un entier (identifiant du produit).</p>

<h2>Conclusion</h2>

<p>Il vous est maintenant très facile, via un peu de configuration, de changer les différents affichages de vos produits sans vous prendre la tête.</p>

<p>Rien ne vous empêche comme vous pouvez le voir de créer un mode didié à une page en particulier.</p>

<p>Vous pouvez <a href="https://github.com/jacquesbh/jbh_catalog">retrouver le module <code>Jbh_Catalog</code> sur Github</a>.</p>

 -->





    </div>
    <div class="voirPlus">
        <div class="social">
            <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://jacques.sh/un-push-pour-vos-produits-sur-magento.html" data-text="Un push pour vos produits" data-via="jacquesbh">Tweet</a>
        </div>
        
        <a href="/un-push-pour-vos-produits-sur-magento.html#disqus_thread">Commentaires</a> -
        

        <a href="/un-push-pour-vos-produits-sur-magento.html">Lire l'article</a>

    </div>

    <hr />
    <h2><a href="/le-layout-sur-magento.html">Le Layout sur Magento</a></h2>
    <div class="content post">
        <p>Le <em>Layout</em> est une partie vraiment importante que tout développeur Magento doit connaître.</p>

<p>De premier abord il n'est pas simple de comprendre le fonctionnement du layout et c'est bien là le but de cet article.</p>

<p>Mais pas seulement ! Je vais aussi vous donner quelques trucs pour maîtriser encore mieux le layout !</p>

<!-- 


<hr />

<p>Le <strong>Layout</strong> c'est du <em>XML</em>.</p>

<p>La balise principale est <code>layout</code>, quoi de mieux ?</p>

<h2>Les handles</h2>

<p>Le layout de Magento est vraiment très complet. On a des fichiers de plusieurs centaines de lignes parfois. Mais comment distinguer quelles parties du layout vont s'appliquer à notre page ?</p>

<p>Les <em>handles</em> sont des balises libres. Lors de son chargement Magento complète une liste de <em>handles</em> qui seront utilisés lors du rendu final.</p>

<p>Pour dire à notre action, dans notre contrôleur, d'utiliser les handles par défaut il faut utiliser la ligne de code suivante :</p>

<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">indexAction</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Ci-dessous la ligne qui charge les handles par défaut du Layout</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">loadLayout</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>


<p>La méthode <code>loadLayout()</code> appelle deux méthodes qui sont les méthodes qui ajoutent réellement les handles par défaut :</p>

<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getLayout</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getUpdate</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">addHandle</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">);</span>
</code></pre></div>


<p>et</p>

<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="nx">addActionLayoutHandles</span><span class="p">();</span>
</code></pre></div>


<p>Pour une action qui serait <code>jbh_foo/bar/baz</code> nous aurions les handles suivants :</p>

<ul>
<li> <code>default</code> : handle principal par défaut</li>
<li> <code>STORE_default</code> : handle du store (par défaut)</li>
<li> <code>THEME_frontend_default_default</code> : handle du thème (par défaut)</li>
<li> <code>jbh_foo_bar_baz</code> : handle de notre action</li>
</ul>


<p>On peut changer le handle <code>default</code> par autre chose si on le précise comme ceci :</p>

<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">loadLayout</span><span class="p">(</span><span class="s1">&#39;other&#39;</span><span class="p">);</span>
</code></pre></div>


<p>Avant le chargement de ces layouts l'évènement <code>controller_action_layout_load_before</code> est lancé par Magento. Donc si vous souhaitez ajouter un handle il faut le faire avant cet évènement.</p>

<p>Magento peut gérer des handles à l'infinie.</p>

<p>Attention cependant : L'ordre de traitement de ces handle a son importance ! Car on peut faire de la surcharge de <code>name</code> et bien d'autres choses encore !</p>

<p>Dans le layout, on peut demander à charger un handle défini de la manière suivante :</p>

<div class="highlight"><pre><code class="xml"><span class="nt">&lt;update</span> <span class="na">handle=</span><span class="s">&quot;nom_du_handle&quot;</span> <span class="nt">/&gt;</span>
</code></pre></div>


<p>C'est très pratique ! Et ça permet surtout de ne pas dupliquer de code !</p>

<h3>Comment trouver le handle d'une page ?</h3>

<p>Prenons par exemple la page de connexion dont l'URL est : <code>https://example.org/customer/account/login</code></p>

<p>Il nous suffit de remplacer les <code>/</code> par des <code>_</code> :</p>

<pre><code>customer_account_login
</code></pre>

<p>En règle générale :</p>

<ul>
<li> En premier c'est le <strong>nom de la route</strong> (et pas du module !)</li>
<li> En deuxième c'est le <strong>nom du contrôleur</strong></li>
<li> En troisième c'est le <strong>nom de l'action</strong></li>
</ul>


<h2>Les blocks</h2>

<p>Le layout c'est plein de <code>block</code> qui ont tous deux attributs principaux :</p>

<ul>
<li> <code>type</code> ou <code>class</code> : indique la classe PHP du block (par exemple : <code>jbh_foo/bar</code> indique la classe <code>Jbh_Foo_Block_Bar</code> – à priori)</li>
<li> <code>name</code> : indique le nom du block dans le layout (doit être unique)</li>
</ul>


<p>On peut ensuite trouver d'autres attributs tels que :</p>

<ul>
<li> <code>template</code> : indique le path du fichier template <code>.phtml</code> utilisé par le block</li>
<li> <code>as</code> : indique le <em>nom</em> du block dans son parent</li>
<li> <code>translate</code> : indique les différentes balises qui peuvent être traduites (<code>label</code> est la valeur la plus utilisée)</li>
<li> <code>output</code> : indique la méthode du block à utiliser pour forcer l'affichage de celui-ci</li>
<li> <code>parent</code> : indique le nom du block parent (surcharge le parent réel dans le XML)</li>
<li> <code>before</code> : indique la place du block dans son parent (si la valeur est <code>-</code> alors le block sera ajouté tout au début de la liste des blocks enfants de son parent)</li>
<li> <code>after</code> : indique la place du block dans son parent (si la valeur est <code>-</code> alors le block sera ajouté tout à la fin de la liste des blocks enfants de son parent). Cet attribut n'est pas traité si <code>before</code> existe. Si la valeur est <code>-</code> et qu'un block est généré ensuite avec un <code>after="-"</code> alors ce dernier prendra la place en fin de liste.</li>
</ul>


<h3>Surcharger un block</h3>

<p>On peut surcharger un block dans le layout, pour changer son type par exemple !</p>

<p>Deux solutions :</p>

<ol>
<li>  Changer le type directement dans le fichier <code>.xml</code> qui déclare le block.</li>
<li>  Ajouter un nouveau block avec le même <code>name</code>.</li>
</ol>


<p>La première solution a l'avantage de ne pas créer d'instance de block inutilisée. Cependant elle a le désavantage d'obliger (bien souvent) le développeur à copier le fichier <code>.xml</code> du core dans son nouveau thème et à en modifier le contenu.</p>

<p>La seconde solution permet en fait d'écraser un block existant. Le problème dans ce cas c'est que lorsqu'on écrase le block, celui-ci disparaît du layout mais il reste dans son parent (sauf si on ajoute l'attribut <code>parent</code> à notre nouveau block, auquel cas il y a aussi un écrasement). On perd également toutes les opérations effectuée sur le vieux block, ainsi que tous ces enfants (qui sont toujours dans le layout mais qui étaient dans le block qu'on tente de remplacer).</p>

<p>En conclusion il est plus simple d'utiliser la première méthode. Cependant la seconde méthode peut avoir un avantage si on souhaite surcharger un block simple (qui n'a pas d'enfants) et sur lequel il n'y a pas eu d'<code>action</code> (voir plus bas « Les actions »).</p>

<h2>Les références</h2>

<p>Dans un <code>handle</code> on peut récupérer un block en utilisant une référence.</p>

<p>Une référence c'est juste un rappel du block pour permettre l'appel à des actions ou l'ajout de blocks enfants.</p>

<p>Une référence peut être insérée à n'importe quel endroit dans le handle : dans un block ou même dans une autre référence.</p>

<p>Un seul attribut est nécessaire (et obligatoire) pour la balise <code>reference</code> : l'attribut <code>name</code>. Celui-ci indique le nom du block à utiliser en tant que parent pour tout ce qui est dans le noeud <code>reference</code> en cours de traitement.</p>

<p>Par exemple pour faire une référence au content, pour y ajouter un block par exemple, sur toutes les pages (handle <code>default</code> donc) :</p>

<div class="highlight"><pre><code class="xml"><span class="nt">&lt;default&gt;</span>
    <span class="nt">&lt;reference</span> <span class="na">name=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;block</span> <span class="na">type=</span><span class="s">&quot;core/text_list&quot;</span> <span class="na">name=</span><span class="s">&quot;sub_content&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/reference&gt;</span>
<span class="nt">&lt;/default&gt;</span>
</code></pre></div>


<h2>Les actions</h2>

<p>Les actions sont très pratiques ! On utilise le XML du layout pour appeler des méthodes d'un block !</p>

<p>(La principale action utilisée est celle qui consiste à changer le template d'un block.)</p>

<p>Une <code>action</code> comprend 2 attributs :</p>

<ul>
<li> <code>method</code> : il est obligatoire, il indique la méthode du block à appeler (peut être une méthode magique ! si si  <code>;)</code>)</li>
<li> <code>block</code> : il est facultatif, il permet d'indiquer le block sur lequel l'action doit être appliquée.</li>
</ul>


<p>Une action fait donc appel à une méthode de son block :</p>

<ul>
<li> soit le block parent dans le Layout</li>
<li> soit le block précisé par l'attribut <code>block</code></li>
</ul>


<p>Dans les deux cas il faut préciser (sauf s'il n'y en a pas) les paramètres de la méthode.</p>

<p>Pour cela il suffit de suivre une logique simple :</p>

<ul>
<li> Le premier paramètre sera le premier enfant de l'action</li>
<li> Le second paramètre sera le second enfant de l'action</li>
<li> etc.</li>
</ul>


<p>Si bien que si nous avons par exemple la méthode suivante :</p>

<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">addLink</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$path</span><span class="p">,</span> <span class="nv">$label</span><span class="p">,</span> <span class="nv">$urlParams</span> <span class="o">=</span> <span class="k">array</span><span class="p">());</span>
</code></pre></div>


<p>Nous aurons l'action ci-dessous :</p>

<div class="highlight"><pre><code class="xml"><span class="nt">&lt;action</span> <span class="na">method=</span><span class="s">&quot;addLink&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;param1&gt;</span>name<span class="nt">&lt;/param1&gt;</span>
    <span class="nt">&lt;param2&gt;</span>path<span class="nt">&lt;/param2&gt;</span>
    <span class="nt">&lt;param3&gt;</span>label<span class="nt">&lt;/param3&gt;</span>
<span class="nt">&lt;/action&gt;</span>
</code></pre></div>


<p>Nous ne mettons pas de 4ème balise car nous ne voulons pas préciser de 4ème paramètre lors de notre appel.</p>

<p>D'ailleurs... ce 4ème paramètre c'est un tableau !</p>

<p>Pour les tableaux c'est un peu plus compliqué...</p>

<p>Notez que bien souvent le nom d'une balise correspond au nom de la variable en paramètre de la méthode, pour plus de clareté (et uniquement pour cette raison, sauf pour les tableaux <code>;)</code>).</p>

<h3>Les tableaux en paramètre</h3>

<p>Pour un tableau de valeurs (indexé) il faut faire :</p>

<div class="highlight"><pre><code class="xml"><span class="nt">&lt;action</span> <span class="err">...</span><span class="nt">&gt;</span>
    <span class="nt">&lt;tab&gt;</span>value_1<span class="nt">&lt;/tab&gt;</span>
    <span class="nt">&lt;tab&gt;</span>value_2<span class="nt">&lt;/tab&gt;</span>
    <span class="nt">&lt;tab&gt;</span>value_3<span class="nt">&lt;/tab&gt;</span>
    <span class="nt">&lt;tab&gt;</span>value_4<span class="nt">&lt;/tab&gt;</span>
<span class="nt">&lt;/action&gt;</span>
</code></pre></div>


<p>Pour un tableau associatif il faut faire :</p>

<div class="highlight"><pre><code class="xml"><span class="nt">&lt;action</span> <span class="err">...</span><span class="nt">&gt;</span>
    <span class="nt">&lt;tab&gt;</span>
        <span class="nt">&lt;cle_1&gt;</span>value_1<span class="nt">&lt;/cle_1&gt;</span>
        <span class="nt">&lt;cle_2&gt;</span>value_2<span class="nt">&lt;/cle_2&gt;</span>
        <span class="nt">&lt;cle_3&gt;</span>value_3<span class="nt">&lt;/cle_3&gt;</span>
    <span class="nt">&lt;/tab&gt;</span>
<span class="nt">&lt;/action&gt;</span>
</code></pre></div>


<p>Et bien sûr on peut aller loin...</p>

<div class="highlight"><pre><code class="xml"><span class="nt">&lt;action</span> <span class="err">...</span><span class="nt">&gt;</span>
    <span class="nt">&lt;tab&gt;</span>
        <span class="nt">&lt;cle_1&gt;</span>value_1<span class="nt">&lt;/cle_1&gt;</span>
        <span class="nt">&lt;cle_2&gt;</span>value_2<span class="nt">&lt;/cle_2&gt;</span>
        <span class="nt">&lt;cle_3&gt;</span>
            <span class="nt">&lt;cle_4&gt;</span>value_4<span class="nt">&lt;/cle_4&gt;</span>
            <span class="nt">&lt;cle_5&gt;</span>value_5<span class="nt">&lt;/cle_5&gt;</span>
            <span class="nt">&lt;cle_6&gt;</span>
                <span class="nt">&lt;cle_7&gt;</span>value_7<span class="nt">&lt;/cle_7&gt;</span>
                <span class="nt">&lt;cle_8&gt;</span>value_8<span class="nt">&lt;/cle_8&gt;</span>
            <span class="nt">&lt;/cle_6&gt;</span>
        <span class="nt">&lt;/cle_3&gt;</span>
    <span class="nt">&lt;/tab&gt;</span>
<span class="nt">&lt;/action&gt;</span>
</code></pre></div>


<p>Et ainsi de suite !</p>

<p><em>Par contre à partir du second niveau vous ne pourrez plus faire de tableaux indexés.</em></p>

<h3>Changer le template d'un block</h3>

<p>Nous voulons par exemple changer le template de la page de login (template global).</p>

<p>D'abord il nous faut déterminer le handle de cette page le plus approprié. Le plus simple quand il faut modifier le template d'un block qui n'est que sur une seule page c'est d'utiliser le handle de l'action. Ici nous avons donc le handle suivant :</p>

<pre><code>customer_account_login
</code></pre>

<p>Ensuite nous devons trouver le block sur lequel nous devons changer le template.
Comme nous voulons changer le template global, le block est <code>root</code>.</p>

<p>Nous avons maintenant deux possibilités :</p>

<p>Soit on passe par une référence :</p>

<div class="highlight"><pre><code class="xml"><span class="nt">&lt;customer_account_login&gt;</span>
    <span class="nt">&lt;reference</span> <span class="na">name=</span><span class="s">&quot;root&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;action</span> <span class="na">method=</span><span class="s">&quot;setTemplate&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;template&gt;</span>customer/account/new_login.phtml<span class="nt">&lt;/template&gt;</span>
        <span class="nt">&lt;/action&gt;</span>
    <span class="nt">&lt;/reference&gt;</span>
<span class="nt">&lt;/customer_account_login&gt;</span>
</code></pre></div>


<p>Soit on utilise l'attribut <code>block</code> :</p>

<div class="highlight"><pre><code class="xml"><span class="nt">&lt;customer_account_login&gt;</span>
    <span class="nt">&lt;action</span> <span class="na">method=</span><span class="s">&quot;setTemplate&quot;</span> <span class="na">block=</span><span class="s">&quot;root&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;template&gt;</span>customer/account/new_login.phtml<span class="nt">&lt;/template&gt;</span>
    <span class="nt">&lt;/action&gt;</span>
<span class="nt">&lt;/customer_account_login&gt;</span>
</code></pre></div>


<p><strong>Il s'avère qu'il est d'ailleurs préférable de changer le template d'un block en utilisant l'attribut <code>block</code> plutôt qu'en utilisant une référence</strong> car c'est moins coûteux en ressources : on fait une itération en moins dans la génération des blocks. (c'est peu certes, mais c'est par là que passe l'optimisation... aussi)</p>

<h2>Ignorer un block</h2>

<p>On voit de temps en temps une petite ligne qui ressemble à ceci :</p>

<div class="highlight"><pre><code class="xml"><span class="nt">&lt;remove</span> <span class="na">name=</span><span class="s">&quot;left&quot;</span> <span class="nt">/&gt;</span>
</code></pre></div>


<p>Cette balise permet d'ignorer un block. Ici on ignore le block <code>left</code> (la colonne de gauche).</p>

<p>Et il arrive assez fréquemment que le développeur se demande si le fait de mettre cette balise avant ou après la création d'un block aura un impact différent.</p>

<p>La réponse est <strong>non</strong>.</p>

<p>En effet, Magento utilise <em>XPATH</em> pour ignorer tous les noeuds et toutes les références aux noeuds dont le nom est indiqué dans l'attribut <code>name</code> de tous les tags <code>remove</code> du Layout.</p>

<p>Si vous ne voulez pas qu'un noeud soit finalement ignoré il faut réussir à supprimer le noeud <code>remove</code> qui le « supprime » ! (logique !)</p>

<p>(Sinon vous pouvez aller voir du côté du module <a href="http://alanstorm.com/magento_layout_unremove_in_local_xml">Layout UnRemove de Alan Storm</a>.)</p>

<p>La balise <code>remove</code> accepte l'attribut <code>acl</code> pour indiquer si on ignore ou non ce block dans le cas d'un layout admin. L'attribut prend la valeur du droit nécessaire pour afficher le block comme par exemple :</p>

<div class="highlight"><pre><code class="xml"><span class="nt">&lt;remove</span> <span class="na">name=</span><span class="s">&quot;foo&quot;</span> <span class="na">acl=</span><span class="s">&quot;jbh_foo/bar&quot;</span> <span class="nt">/&gt;</span>
</code></pre></div>


<p>Si l'administrateur connecté a le droit <code>jbh_foo/bar</code> alors le block ne sera pas ignoré.</p>

<p>A noter aussi qu'on peut inhiber l'action du remove sur un block en définissant l'attribut <code>ignore</code> de celui-ci !</p>

<div class="highlight"><pre><code class="xml"><span class="nt">&lt;block</span> <span class="na">name=</span><span class="s">&quot;foo&quot;</span> <span class="na">type=</span><span class="s">&quot;core/text_list&quot;</span> <span class="na">ignore=</span><span class="s">&quot;0&quot;</span> <span class="nt">/&gt;</span>
</code></pre></div>


<p>Ce block ne pourra donc pas être supprimé via <code>remove</code>. Attention par contre... vu qu'on ne peut pas ajouter un attribut à un block déjà existant (via une référence par exemple) cette manipulation implique que le block ne sera <strong>jamais</strong> ignoré.</p>

<h2>Le fichier <code>local.xml</code> (dans <code>design/../layout/</code>)</h2>

<p>Surprise ! Ce fichier est toujours parsé en dernier ! Donc si vous souhaitez faire de la mise à jour pour un thème sans rien en particulier vous pouvez utiliser ce fichier.</p>

<p>C'est bon à savoir non ?</p>

<p>Avec lui, plus besoin de faire un module pour « nettoyer » votre thème :)</p>

<h2>Un recherché remplacé ?</h2>

<p>Oui ! Magento effectue un <code>str_replace</code> sur tout votre XML comme ceci :</p>

<ul>
<li><code>{{baseUrl}}</code> devient l'URL non sécurisée de votre store</li>
<li><code>{{baseSecureUrl}}</code> devient l'URL sécurisée de votre store</li>
</ul>


<h2>Les updates</h2>

<p>Un update c'est simplement un bout de XML ajouté au layout qui sera traité de la même façon que tous les fichiers <code>.xml</code> de votre thème.</p>

<h3>Le tag <code>update</code></h3>

<p>Il ne peut être qu'un enfant d'un <em>handle</em>, sinon il ne sera pas pris en compte.</p>

<p>Il doit comporter un seul attribut : <code>handle</code>.</p>

<p>Cet attribut indique le nom d'un autre <em>handle</em> qui doit être pris en compte dans le layout.</p>

<p>Vous pouvez par exemple vouloir appliquer le handle <code>customer_account</code> à votre nouvelle page pour qu'elle s'intègre parfaitement dans la partie "Mon Compte" du client :</p>

<div class="highlight"><pre><code class="xml"><span class="nt">&lt;handle_de_ma_nouvelle_page&gt;</span>
    <span class="nt">&lt;update</span> <span class="na">handle=</span><span class="s">&quot;customer_account&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/handle_de_ma_nouvelle_page&gt;</span>
</code></pre></div>


<p>Vous pouvez également utiliser cette technique pour éviter de dupliquer un gros bout de layout que vous voudriez réutiliser !</p>

<h3>Des updates en base de données</h3>

<p>Les Widgets utilisent la base de données pour ajouter des updates sur le layout.</p>

<p>Il nous est possible de faire de même si on le souhaite en utilisant les deux tables <code>core_layout_link</code> et <code>core_layout_update</code>.</p>

<p>Désactiver le module des Widgets n'empêchera pas Magento de faire une requête <code>SELECT</code> par <em>handle</em> par page.</p>

<p>Donc si vous n'avez pas de cache, sachez que Magento fait au <strong>minimum</strong> 4 requêtes pour récupérer les possibles <em>layout updates</em> en base de données à chaque chargement.</p>

<p>A savoir que la sauvegarde d'un seul Widget invalidera les caches suivants :</p>

<ul>
<li> Le cache « Blocks HTML output  » (<code>block_html</code>)</li>
<li> Le cache « Layouts » (<code>layout</code>)</li>
</ul>


<p>Merci les widgets ! (à utiliser avec parcimonie donc...)</p>

<h2>Conclusion</h2>

<p>Vous maîtrisez maintenant le layout sur Magento ! Au moins vous avez les connaissances... Vous savez comment créer, modifier, supprimer tout ou partie du Layout. Il ne vous manque plus que la pratique !</p>

<p>A présent n'hésitez surtout pas à laisser un commentaire sur vos astuces bien à vous ;) Ou simplement pour réagir à cet article !</p>

 -->



    </div>
    <div class="voirPlus">
        <div class="social">
            <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://jacques.sh/le-layout-sur-magento.html" data-text="Le Layout sur Magento" data-via="jacquesbh">Tweet</a>
        </div>
        
        <a href="/le-layout-sur-magento.html#disqus_thread">Commentaires</a> -
        

        <a href="/le-layout-sur-magento.html">Lire l'article</a>

    </div>


<div class="pagination">
    <hr/>
    
    
    
    <a href="/page3" class="previous">Précédent</a>
    
    –
    
    
    <span class="page_number">Page 4 sur 7</span>
    
    
    –
    <a href="/page5" class="next">Suivant</a>
    
    
</div>



</div>

<script type="text/javascript">
    var disqus_shortname = 'jacquesbh';
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>



    </div>

    <div id="bottomWrap">
        <div id="contactWrap">
            <form action="#" method="post" id="contact_form">
                <h3>Contact</h3>
                <p>
                    <label for="contactNom">Votre nom</label>
                    <input type="text" name="contact_name" id="contact_name" class="text" tabindex="1" />
                </p>
                <p>
                    <label for="contactEmail">Votre email</label>
                    <input type="email" name="contact_email" id="contact_email" class="text" tabindex="2" />
                </p>
                <p>
                    <label for="contactMessage">Message</label>
                    <textarea name="contact_message" id="contact_message" rows="5" cols="30" tabindex="8"></textarea>
                </p>
                <p class="send">
                    <input type="hidden" name="redirect_to" value="http://jacques.sh/contact/thanks.html" />
                    <input type="submit" id="contactSend" value="Envoyer" tabindex="9" />
                </p>
                <div style="display: none;" class="url">http://getsimpleform.com/messages?form_api_token=4ba030c3b67553e1ccb25710aee63bd6</div>
            </form>
            <div class="qrcode">
                <h3>Mon QRcode</h3>
                <p>
                    <img src="/img/qrcode.png" alt="le QRcode" width="198" height="192" />
                </p>
            </div>
        </div>

        <div id="footerWrap">
            <div class="social">
                <a href="https://twitter.com/jacquesbh" class="twitter-follow-button" data-show-count="false">Follow @jacquesbh</a>
            </div>
            
            <a href="http://monsieurbiz.com" title="Découvrez Monsieur Biz, une agence spécialisée sur Magento, solution e-commerce">Agence Magento</a>
            | 

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
            
            <a href="/credits.html">Crédits</a>
        
    

    
        
    

    
        
    

    
        
            |
            <a href="/legals.html">Informations légales</a>
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    





            | <a href="/atom.xml">RSS</a>
            | <a href="#" id="toplink">Haut de page</a>
            <br />
            <span class="copy">&copy; Jacques Bodin-Hullin - 2014</span>
        </div>
    </div>

</div>




  <script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-27192340-2', 'auto');
  ga('send', 'pageview');

</script>






<script type="text/javascript" src="/js/jquery/cookies.js"></script>
    <div id="popin" class="monsieurbiz-popin" style="display: none;">
        <img src="/img/monsieurbiz.png" alt="" height="250" style="height: 250px;" />
        <h2><span class="lines">Un projet, Une agence</span></h2>
        <div class="action">
            <p>
                Monsieur Biz, une agence spécialisée Magento pour votre projet.
            </p>
            <a href="http://monsieurbiz.com">
                <div class="button1">C'est par ici que ça se passe !</div>
            </a>
        </div>
    </div>

    <script type="text/javascript">
    if (typeof disable_popin === 'undefined' || !disable_popin) {
        (function ($) {
            $(document).ready(function () {
                var cookieId = 'monsieurbizPopinDisplayed';
                if ($.cookie(cookieId) == null) {
                    $.fancybox.open('#popin');
                    $.cookie(cookieId, 'true', { expires: 15 });
                }
            });
         })(jQuery);
    }
    </script>


<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

</body>
</html>

