

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <title>Supprimer le merge des paniers - Jacques Bodin-Hullin, développeur Magento</title>
    <meta name="description" content="N'avez-vous jamais voulu supprimer le merge entre le panier sauvegardé du client et le panier du visiteur lorsque celui-ci se connecte ?">
    <meta name="keywords" content="magento, catalog, catalogue, product, produit, block">
    <meta name="author" content="Jacques Bodin-Hullin">
    <link href="/css/style.css" rel="stylesheet" type="text/css" />
    <link href="/css/pygments.css" rel="stylesheet" type="text/css" media="all">
    <link href="/js/fancybox/jquery.fancybox.css" rel="stylesheet" type="text/css" media="all">
    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="/favicon.ico">
  <!-- Update these with your own images
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
    <link rel="alternate" type="application/rss+xml" title="Jacques Bodin-Hullin - Latest Posts" href="/atom.xml" >

    <script type="text/javascript" src="/js/jquery-1.10.2.min.js" ></script>
    <script type="text/javascript" src="/js/fancybox/jquery.fancybox.pack.js" ></script>
    <script type="text/javascript" src="/js/event.js" ></script>
    <script type="text/javascript" src="/js/functions.js" ></script>

    <style for="gists"></style>
</head>
<body class="">

<div id="mainWrap">

    <div id="topWrap">
        <div id="headerWrap">
            <p>
                Jacques Bodin-Hullin
                <span class="baseline">Développeur d'applications Web</span>
            </p>
            <a href="http://jacques.sh"></a>

            <div id="magento_certified">
                <a href="http://www.magentocommerce.com/certification/directory/dev/69536/" title="L'Agence Monsieur Biz est certifiée Magento Solution Specialist" class="solution-specialist" target="_blank"></a>
                <a href="http://www.magentocommerce.com/certification/directory/dev/69536/" title="L'Agence Monsieur Biz est certifiée Magento Developer Plus" class="developer-plus" target="_blank"></a>
                <a href="http://www.magentocommerce.com/certification/directory/dev/69536/" title="Jacques Bodin-Hullin, développeur certifié Magento Developer" class="developer" target="_blank"></a>
                <a href="http://www.magentocommerce.com/certification/directory/dev/69536/" title="Jacques Bodin-Hullin est développeur certifié Magento Front End Developer" class="frontend-developer" target="_blank"></a>
            </div>

        </div>

        <blockquote id="quoteWrap">
            
            <p>
                La perfection est atteinte non quand il ne reste rien à ajouter, mais quand il ne reste
                rien à enlever.
            </p>
            <div><cite>Antoine de Saint Exupéry</cite></div>
            
        </blockquote>

        <ul id="menu">
            
            <li><a href="/"><span></span>Accueil</a></li>
            
            <li><a href="https://github.com/jacquesbh" target="_blank"><span></span>Code</a></li>
            
            
    
        
    

    
        
            
            <li><a href="/a-propos.html"><span></span>A propos</a></li>
            
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
            
            <li><a href="/references.html"><span></span>Références</a></li>
            
        
    

    
        
    

    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    




            <li class="search">
                <form action="/search.html" method="get" id="search_form">
                    <div>
                        <input type="text" name="q" placeholder="Votre recherche" />
                    </div>
                </form>
            </li>
        </ul>

        <div class="mbiz">
            <p>
                <a href="http://monsieurbiz.com" title="Découvrez l'agence Monsieur Biz, spécialiste Magento">
                    <img src="/img/monsieurbiz_bg.png" title="L'Agence Monsieur Biz" />
                    <span>Vous cherchez une agence à taille humaine spécialisée sur la solution e-commerce Magento ? L'agence Monsieur Biz est faite pour vous.</span>
                </a>
            </p>
        </div>
    </div>

    <div id="globalWrap">


    

    <div id="contentWrap" class="post">

        <h1>Supprimer le merge des paniers</h1>

        <p>Sur presque tous les projets Magento sur lesquels j'ai eu l'occasion de travailler il est apparu nécessaire de désactiver le merge du panier du client avec celui du visiteur lors de la connexion.</p>

<p>Pour cela nous devons commencer par <strong>identifier l'évènement</strong> lancé par Magento qui puisse nous permettre de supprimer ce fameux « merge » car aucune option en admin nous permet de l'empêcher.</p>

<!-- more start -->


<hr />

<h2>Identifier l'évènement</h2>

<p>Il suffit d'investiguer un peu :</p>

<p>Objet <code>Mage_Sales_Model_Quote</code>, qui est donc notre objet « panier » :</p>

<p>Ligne 1678 : <code>public function merge(Mage_Sales_Model_Quote $quote)</code>.</p>

<p>Pour vérifier que notre merge passe bien par là on y place un log : <code>Mage::log(__METHOD__ . ':' . __LINE__);</code>.</p>

<p>On se connecte, on ajoute un produit à notre panier, on se déconnecte, on ajoute un produit dans notre panier et on se connecte à nouveau : là on a un log qui apparaît.</p>

<p>Nous avons trouvé sans trop de difficultés l'endroit où est fait le merge.</p>

<p>On remarque dans la méthode le lancement d'un évènement intéressant :</p>

<div class="highlight"><pre><code class="php"><span class="x">Mage::dispatchEvent(</span>
<span class="x">    $this-&gt;_eventPrefix . &#39;_merge_before&#39;,</span>
<span class="x">    array(</span>
<span class="x">    $this-&gt;_eventObject=&gt;$this,</span>
<span class="x">        &#39;source&#39;=&gt;$quote</span>
<span class="x">    )</span>
<span class="x">);</span>
</code></pre></div>


<p>A partir de là on déduit que l'évènement est <code>sales_quote_merge_before</code> et que ces deux données sont :</p>

<ol>
<li>  Le panier <code>quote</code> : panier du client</li>
<li>  Le panier <code>source</code> : panier du visiteur</li>
</ol>


<h2>La construction du module</h2>

<ol>
<li>  Un modèle <code>Observer</code> qui <code>catch</code> notre évènement et qui vide le panier du client.</li>
<li>  Un helper <code>Data</code> qui nous permet de savoir si notre module est activé et si on peut vider le panier du client quand celui du visiteur est vide.</li>
<li>  Un fichier <code>system.xml</code> qui nous permet d'ajouter un peu de configuation (configuration utilisée dans le helper).</li>
</ol>


<h3>Le helper</h3>

<p>Le helper n'est utilisé que pour savoir deux choses :</p>

<ol>
<li>  Notre module est-il activé ? Ou plutôt, pouvons-nous supprimer le merge des paniers ? Via la méthode <code>isActive</code>.</li>
<li>  Pouvons-nous vider le panier du client si le panier du visiteur est vide ? Via la méthode <code>cleanIfEmpty</code>.</li>
</ol>


<script src="http://gist-it.appspot.com/github/jacquesbh/jbh_cartmerge/raw/master/app/code/community/Jbh/CartMerge/Helper/Data.php"></script>


<h3>Le modèle</h3>

<p>Le modèle <code>catch</code> notre évènement est vide le panier du client que si les conditions suivantes sont validées&nbsp;:</p>

<ol>
<li>  Notre module est actif.</li>
<li>  Le panier du visiteur a des produits OU on peut vider le panier du client si le panier du visiteur est vide.</li>
</ol>


<script src="http://gist-it.appspot.com/github/jacquesbh/jbh_cartmerge/raw/master/app/code/community/Jbh/CartMerge/Model/Observer.php"></script>


<h3>Le <code>system.xml</code></h3>

<p>Le <code>system.xml</code> permet d'ajouter un peu de configuration, tout simplement.</p>

<p>Nous ne nous prenons pas la tête avec les <code>ACL</code> car ils sont déjà gérés par Magento pour cette partie de la configuration.</p>

<script src="http://gist-it.appspot.com/github/jacquesbh/jbh_cartmerge/raw/master/app/code/community/Jbh/CartMerge/etc/system.xml"></script>


<h2>Conclusion</h2>

<p>Il est en réalité assez simple, à présent, via le module complet, ou en suivant les étapes de cet article, de supprimer le merge des paniers du visiteur et du client lors de la connexion de notre client.</p>

<p>Vous trouverez le <a href="https://github.com/jacquesbh/jbh_cartmerge">code complet du module sur github</a>.</p>

<!-- more end -->



        <hr />

        
        <h2 id="comments">Commentaires</h2>
        


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'jacquesbh'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




        
    </div>

    <div id="sideWrap">

    <h2>Quelques infos</h2>
    <ul class="infos">
        <li>
            <span>Par</span>
            <strong>Jacques Bodin-Hullin</strong>
            
        </li>
        <li>
            <span>Publié le</span>
            <strong>21 October 2012</strong>
        </li>
        <li>
            <span>Les tags</span>
            <strong>
                
                <a href="/search.html#!tag=Magento">Magento</a>, 
                
                <a href="/search.html#!tag=Cart">Cart</a>, 
                
                <a href="/search.html#!tag=Customer">Customer</a>
                
            </strong>
        </li>
        
        <li>
            <span>Dépôt GitHub</span>
            <strong><a href="https://github.com/jacquesbh/jbh_cartmerge">jacquesbh/jbh_cartmerge</a></strong>
        </li>
        
        
    </ul>

    <div class="social">
        <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://jacques.sh/supprimer-le-merge-des-paniers.html" data-text="Supprimer le merge des paniers" data-via="jacquesbh">Tweet</a>
    </div>

    
</div>


    </div>

    <div id="bottomWrap">
        <div id="contactWrap">
            <form action="#" method="post" id="contact_form">
                <h3>Contact</h3>
                <p>
                    <label for="contactNom">Votre nom</label>
                    <input type="text" name="contact_name" id="contact_name" class="text" tabindex="1" />
                </p>
                <p>
                    <label for="contactEmail">Votre email</label>
                    <input type="email" name="contact_email" id="contact_email" class="text" tabindex="2" />
                </p>
                <p>
                    <label for="contactMessage">Message</label>
                    <textarea name="contact_message" id="contact_message" rows="5" cols="30" tabindex="8"></textarea>
                </p>
                <p class="send">
                    <input type="hidden" name="redirect_to" value="http://jacques.sh/contact/thanks.html" />
                    <input type="submit" id="contactSend" value="Envoyer" tabindex="9" />
                </p>
                <div style="display: none;" class="url">http://getsimpleform.com/messages?form_api_token=4ba030c3b67553e1ccb25710aee63bd6</div>
            </form>
            <div class="qrcode">
                <h3>Mon QRcode</h3>
                <p>
                    <img src="/img/qrcode.png" alt="le QRcode" width="198" height="192" />
                </p>
            </div>
        </div>

        <div id="footerWrap">
            <div class="social">
                <a href="https://twitter.com/jacquesbh" class="twitter-follow-button" data-show-count="false">Follow @jacquesbh</a>
            </div>
            
            <a href="http://monsieurbiz.com" title="Découvrez Monsieur Biz, une agence spécialisée sur Magento, solution e-commerce">Agence Magento</a>
            | 

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
            
            <a href="/credits.html">Crédits</a>
        
    

    
        
    

    
        
    

    
        
            |
            <a href="/legals.html">Informations légales</a>
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    

    
        
    





            | <a href="/atom.xml">RSS</a>
            | <a href="#" id="toplink">Haut de page</a>
            <br />
            <span class="copy">&copy; Jacques Bodin-Hullin - 2014</span>
        </div>
    </div>

</div>




  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-27192340-2']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>





<script type="text/javascript" src="/js/jquery/cookies.js"></script>
    <div id="popin" class="monsieurbiz-popin" style="display: none;">
        <img src="/img/monsieurbiz.png" alt="" height="250" style="height: 250px;" />
        <h2><span class="lines">Un projet, Une agence</span></h2>
        <div class="action">
            <p>
                Monsieur Biz, une agence spécialisée Magento pour votre projet.
            </p>
            <a href="http://monsieurbiz.com">
                <div class="button1">C'est par ici que ça se passe !</div>
            </a>
        </div>
    </div>

    <script type="text/javascript">
    if (typeof disable_popin === 'undefined' || !disable_popin) {
        (function ($) {
            $(document).ready(function () {
                var cookieId = 'monsieurbizPopinDisplayed';
                if ($.cookie(cookieId) == null) {
                    $.fancybox.open('#popin');
                    $.cookie(cookieId, 'true');
                }
            });
         })(jQuery);
    }
    </script>


<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

</body>
</html>

